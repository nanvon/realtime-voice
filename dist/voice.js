!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Voice=t():e.Voice=t()}(self,(()=>(()=>{"use strict";var e={d:(t,n)=>{for(var o in n)e.o(n,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:n[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{Media:()=>n,downloadPCM:()=>h,downloadWAV:()=>m,speak:()=>a,speakMsg:()=>f,stop:()=>s,stopMsg:()=>p});const n=class{constructor(){this._constraints={audio:!0,video:!1};void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(e){let t=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return t?new Promise((function(n,o){t.call(navigator,e,n,o)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))})}promiseStream(){return new Promise(((e,t)=>{let n="";navigator.mediaDevices.getUserMedia(this._constraints).then((t=>{e(t)})).catch((e=>{switch(e.message||e.name){case"PERMISSION_DENIED":case"PermissionDeniedError":case"Permission denied":case"Permission dismissed":n="用户拒绝提供录音信息。";break;case"NOT_SUPPORTED_ERROR":case"NotSupportedError":n="浏览器不支持硬件设备。";break;case"MANDATORY_UNSATISFIED_ERROR":case"MandatoryUnsatisfiedError":n="无法发现指定的硬件设备。";break;default:n=`无法打开麦克风。异常信息：${e.message}`}t(n)}))}))}};let o=null,i=null,r=function(e){let t=new AudioContext,n=t.createMediaStreamSource(e),i=t.createScriptProcessor(4096,1,1),r={size:0,buffer:[],inputSampleRate:48e3,inputSampleBits:16,outputSampleRate:8e3,outputSampleBits:16,clear:function(){this.buffer=[],this.size=0},input:function(e){this.buffer.push(new Float32Array(e)),this.size+=e.length},compress:function(){let e=new Float32Array(this.size),t=0;for(let n=0;n<this.buffer.length;n++)e.set(this.buffer[n],t),t+=this.buffer[n].length;let n=parseInt(this.inputSampleRate/this.outputSampleRate),o=e.length/n,i=new Float32Array(o),r=0,a=0;for(;r<o;)i[r]=e[a],a+=n,r++;return i},encodePCM:function(){Math.min(this.inputSampleRate,this.outputSampleRate);let e=Math.min(this.inputSampleBits,this.outputSampleBits),t=this.compress(),n=t.length*(e/8),o=new ArrayBuffer(n),i=new DataView(o),r=0;for(let e=0;e<t.length;e++,r+=2){let n=Math.max(-1,Math.min(1,t[e]));i.setInt16(r,n<0?32768*n:32767*n,!0)}return new Blob([i])}};this.start=function(){n.connect(i),i.connect(t.destination)},this.stop=function(){i.disconnect()},this.getBlob=function(){return r.encodePCM()},this.clear=function(){r.clear()},i.onaudioprocess=function(e){let t=e.inputBuffer.getChannelData(0);r.input(t),function(){let e=new FileReader;e.onload=e=>{let t=e.target.result,n=new Int8Array(t);if(n.length>0){let e=new Int8Array(1024),t=0;for(let i=0;i<n.byteLength;i++)e[t++]=n[i],(i+1)%1024==0&&(o.send(e),console.log("tmpArr: ",e),e=n.byteLength-i-1>=1024?new Int8Array(1024):new Int8Array(n.byteLength-i-1),t=0),i+1==n.byteLength&&(i+1)%1024!=0&&(o.send(e),console.log("tmpArr: ",e))}},e.readAsArrayBuffer(r.encodePCM()),r.clear()}()}};function a(e,t){(new n).promiseStream().then((t=>{var n;n=new r(t),i=n,console.log("开始对讲"),function(e){o=new WebSocket(e.url),o.binaryType="arraybuffer",o.onopen=function(){console.log("握手成功"),1==o.readyState&&i.start()},o.onmessage=function(e){console.info(e)},o.onerror=function(e){console.info(e)}}(e)})).catch((e=>{t(e)}))}function s(){o&&(o.close(),i.stop(),console.log("关闭对讲以及WebSocket"))}let l=null,c=null,u=function(e){let t=new AudioContext,n=t.createMediaStreamSource(e),o=t.createScriptProcessor(4096,1,1),i={size:0,buffer:[],inputSampleRate:48e3,inputSampleBits:16,outputSampleRate:8e3,outputSampleBits:16,clear:function(){this.buffer=[],this.size=0},input:function(e){this.buffer.push(new Float32Array(e)),this.size+=e.length},compress:function(){let e=new Float32Array(this.size),t=0;for(let n=0;n<this.buffer.length;n++)e.set(this.buffer[n],t),t+=this.buffer[n].length;let n=parseInt(this.inputSampleRate/this.outputSampleRate),o=e.length/n,i=new Float32Array(o),r=0,a=0;for(;r<o;)i[r]=e[a],a+=n,r++;return i},encodePCM:function(){Math.min(this.inputSampleRate,this.outputSampleRate);let e=Math.min(this.inputSampleBits,this.outputSampleBits),t=this.compress(),n=t.length*(e/8),o=new ArrayBuffer(n),i=new DataView(o),r=0;for(let e=0;e<t.length;e++,r+=2){let n=Math.max(-1,Math.min(1,t[e]));i.setInt16(r,n<0?32768*n:32767*n,!0)}return new Blob([i])},encodeWAV:function(){let e=Math.min(this.inputSampleRate,this.outputSampleRate),t=Math.min(this.inputSampleBits,this.outputSampleBits),n=this.compress(),o=n.length*(t/8),i=new ArrayBuffer(44+o),r=new DataView(i),a=0,s=function(e){for(var t=0;t<e.length;t++)r.setUint8(a+t,e.charCodeAt(t))};return s("RIFF"),a+=4,r.setUint32(a,36+o,!0),a+=4,s("WAVE"),a+=4,s("fmt "),a+=4,r.setUint32(a,16,!0),a+=4,r.setUint16(a,1,!0),a+=2,r.setUint16(a,1,!0),a+=2,r.setUint32(a,e,!0),a+=4,r.setUint32(a,1*e*(t/8),!0),a+=4,r.setUint16(a,t/8*1,!0),a+=2,r.setUint16(a,t,!0),a+=2,s("data"),a+=4,r.setUint32(a,o,!0),a+=4,r=this.reshapeWavData(t,a,n,r),r},reshapeWavData:function(e,t,n,o){if(8===e)for(let e=0;e<n.length;e++,t++){let i=Math.max(-1,Math.min(1,n[e])),r=i<0?32768*i:32767*i;r=parseInt(255/(65535/(r+32768))),o.setInt8(t,r,!0)}else for(let e=0;e<n.length;e++,t+=2){let i=Math.max(-1,Math.min(1,n[e]));o.setInt16(t,i<0?32768*i:32767*i,!0)}return o},getFullWavData:function(){const e=this.encodeWAV();return new Blob([e],{type:"audio/wav"})}};this.start=function(){n.connect(o),o.connect(t.destination)},this.stop=function(){o.disconnect()},this.getBlob=function(){return i.encodePCM()},this.getWav=function(){return i.getFullWavData()},this.clear=function(){i.clear()},o.onaudioprocess=function(e){let t=e.inputBuffer.getChannelData(0);i.input(t)}};function f(e,t){(new n).promiseStream().then((t=>{var n;n=new u(t),c=n,console.log("开始对讲"),function(e){l=new WebSocket(e.url),l.binaryType="arraybuffer",l.onopen=function(){console.log("握手成功"),1==l.readyState&&c.start()},l.onmessage=function(e){console.info(e)},l.onerror=function(e){console.info(e)}}(e)})).catch((e=>{t(e)}))}function p(){if(l){let e=new FileReader;e.onload=e=>{let t=e.target.result,n=new Int8Array(t);l.send(n),l.close(),c.stop(),console.log("关闭对讲以及WebSocket")},e.readAsArrayBuffer(c.getBlob())}}function h(){if(null===c)return alert("请先开始录音");var e=document.createElement("a");e.href=window.URL.createObjectURL(c.getBlob()),console.log("oA.href: ",e.href),e.download=e.href.split("/")[3]+".pcm",e.click(),l.close(),c.stop(),console.log("关闭对讲以及WebSocket，然后下载PCM文件")}function m(){if(null===c)return alert("请先开始录音");var e=document.createElement("a");e.href=window.URL.createObjectURL(c.getWav()),console.log("oA.href: ",e.href),e.download=e.href.split("/")[3]+".wav",e.click(),l.close(),c.stop(),console.log("关闭对讲以及WebSocket，然后下载WAV文件")}return t})()));