!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.RealtimeVoice=t():e.RealtimeVoice=t()}(self,(()=>(()=>{"use strict";var e={d:(t,s)=>{for(var n in s)e.o(s,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:s[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{VoiceIntercom:()=>o,VoiceMessage:()=>a});const s=class{constructor(){this._constraints={audio:!0,video:!1};void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(e){let t=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return t?new Promise((function(s,n){t.call(navigator,e,s,n)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))})}promiseStream(){let e=new Promise(((e,t)=>{let s="";navigator.mediaDevices.getUserMedia(this._constraints).then((t=>{e(t)})).catch((e=>{switch(e.message||e.name){case"PERMISSION_DENIED":case"PermissionDeniedError":case"Permission denied":case"Permission dismissed":s="用户拒绝提供录音信息。";break;case"NOT_SUPPORTED_ERROR":case"NotSupportedError":s="浏览器不支持硬件设备。";break;case"MANDATORY_UNSATISFIED_ERROR":case"MandatoryUnsatisfiedError":s="无法发现指定的硬件设备。";break;default:s=`无法打开麦克风。异常信息：${e.message}`}t(s)}))}));return e}},n=function(e,t,s){let n=t.sampleBits||16,r=t.sampleRate||8e3,i=new AudioContext,o=i.createMediaStreamSource(e),a=i.createScriptProcessor(4096,1,1),c={size:0,buffer:[],inputSampleRate:48e3,inputSampleBits:16,outputSampleRate:r,outputSampleBits:n,clear:function(){this.buffer=[],this.size=0},input:function(e){this.buffer.push(new Float32Array(e)),this.size+=e.length},compress:function(){let e=new Float32Array(this.size),t=0;for(let s=0;s<this.buffer.length;s++)e.set(this.buffer[s],t),t+=this.buffer[s].length;let s=parseInt(this.inputSampleRate/this.outputSampleRate),n=e.length/s,r=new Float32Array(n),i=0,o=0;for(;i<n;)r[i]=e[o],o+=s,i++;return r},encodePCM:function(){Math.min(this.inputSampleRate,this.outputSampleRate);let e=Math.min(this.inputSampleBits,this.outputSampleBits),t=this.compress(),s=t.length*(e/8),n=new ArrayBuffer(s),r=new DataView(n),i=0;for(let e=0;e<t.length;e++,i+=2){let s=Math.max(-1,Math.min(1,t[e]));r.setInt16(i,s<0?32768*s:32767*s,!0)}return new Blob([r])},encodeWAV:function(){let e=Math.min(this.inputSampleRate,this.outputSampleRate),t=Math.min(this.inputSampleBits,this.outputSampleBits),s=this.compress(),n=s.length*(t/8),r=new ArrayBuffer(44+n),i=new DataView(r),o=0,a=function(e){for(var t=0;t<e.length;t++)i.setUint8(o+t,e.charCodeAt(t))};return a("RIFF"),o+=4,i.setUint32(o,36+n,!0),o+=4,a("WAVE"),o+=4,a("fmt "),o+=4,i.setUint32(o,16,!0),o+=4,i.setUint16(o,1,!0),o+=2,i.setUint16(o,1,!0),o+=2,i.setUint32(o,e,!0),o+=4,i.setUint32(o,1*e*(t/8),!0),o+=4,i.setUint16(o,t/8*1,!0),o+=2,i.setUint16(o,t,!0),o+=2,a("data"),o+=4,i.setUint32(o,n,!0),o+=4,i=this.reshapeWavData(t,o,s,i),i},reshapeWavData:function(e,t,s,n){if(8===e)for(let e=0;e<s.length;e++,t++){let r=Math.max(-1,Math.min(1,s[e])),i=r<0?32768*r:32767*r;i=parseInt(255/(65535/(i+32768))),n.setInt8(t,i,!0)}else for(let e=0;e<s.length;e++,t+=2){let r=Math.max(-1,Math.min(1,s[e]));n.setInt16(t,r<0?32768*r:32767*r,!0)}return n},getFullWavData:function(){const e=this.encodeWAV();return new Blob([e],{type:"audio/wav"})}};this.start=function(){o.connect(a),a.connect(i.destination)},this.stop=function(){a.disconnect()},this.getBlob=function(){return c.encodePCM()},this.getWav=function(){return c.getFullWavData()},this.clear=function(){c.clear()},a.onaudioprocess=function(e){let t=e.inputBuffer.getChannelData(0);c.input(t),s(c)}};class r{constructor(e){this.config=e,this.url=e.url,this.ws=null,this.record=null}init=e=>{this.record=e};startWs=e=>{this.ws=new WebSocket(e),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{console.log("ws握手成功"),1==this.ws.readyState&&this.record.start()},this.ws.onmessage=function(e){console.info(e)},this.ws.onerror=function(e){console.info(e)}};startSpeak=e=>{(new s).promiseStream().then((e=>{let t=new n(e,this.config,(e=>{let t=new FileReader;t.onload=e=>{let t=e.target.result,s=new Int8Array(t);if(s.length>0){let e=new Int8Array(1024),t=0;for(let n=0;n<s.byteLength;n++)e[t++]=s[n],(n+1)%1024==0&&(this.ws.send(e),e=s.byteLength-n-1>=1024?new Int8Array(1024):new Int8Array(s.byteLength-n-1),t=0),n+1==s.byteLength&&(n+1)%1024!=0&&this.ws.send(e)}},t.readAsArrayBuffer(e.encodePCM()),e.clear()}));this.init(t),this.startWs(this.url)})).catch((t=>{e(t)}))};stopSpeak=()=>{this.ws&&(this.record.stop(),this.ws.close(),console.log("ws关闭成功"))}}class i{constructor(e){this.config=e,this.url=e.url,this.ws=null,this.record=null}init=e=>{this.record=e};startWs=e=>{this.ws=new WebSocket(e),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{console.log("ws握手成功"),1==this.ws.readyState&&this.record.start()},this.ws.onmessage=function(e){console.info(e)},this.ws.onerror=function(e){console.info(e)}};startSpeak=e=>{(new s).promiseStream().then((e=>{let t=new n(e,this.config,(e=>{}));this.init(t),this.startWs(this.url)})).catch((t=>{e(t)}))};stopSpeak=()=>{if(this.ws){let e=new FileReader;e.onload=e=>{let t=e.target.result,s=new Int8Array(t);this.ws.send(s),this.record.stop(),this.ws.close(),console.log("ws关闭成功")},e.readAsArrayBuffer(this.record.getBlob())}};downloadPCM=()=>{if(null===this.record)return console.error("请先开始录音");var e=document.createElement("a");e.href=window.URL.createObjectURL(this.record.getBlob()),console.log("oA.href: ",e.href),e.download=e.href.split("/")[3]+".pcm",e.click(),this.ws.close(),this.record.stop()};downloadWAV=()=>{if(null===this.record)return console.error("请先开始录音");var e=document.createElement("a");e.href=window.URL.createObjectURL(this.record.getWav()),console.log("oA.href: ",e.href),e.download=e.href.split("/")[3]+".wav",e.click(),this.ws.close(),this.record.stop()}}let o={createIntercom:function(e){return new r(e)}},a={createMsg:function(e){return new i(e)}};return t})()));