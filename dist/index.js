!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.RealtimeVoice=e():t.RealtimeVoice=e()}(self,(()=>(()=>{"use strict";var t={875:(t,e,n)=>{n.r(e),n.d(e,{alaw:()=>r,mulaw:()=>i});var r={};n.r(r),n.d(r,{decode:()=>u,decodeSample:()=>a,encode:()=>c,encodeSample:()=>o});var i={};n.r(i),n.d(i,{decode:()=>m,decodeSample:()=>p,encode:()=>d,encodeSample:()=>f});const s=[1,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7];function o(t){let e,n=~(t=-32768==t?-32767:t)>>8&128;if(n||(t*=-1),t>32635&&(t=32635),t>=256){let n=s[t>>8&127];e=n<<4|t>>n+3&15}else e=t>>4;return 85^e^n}function a(t){let e=0;128&(t^=85)&&(t&=-129,e=-1);let n=4+((240&t)>>4),r=0;return r=4!=n?1<<n|(15&t)<<n-4|1<<n-5:t<<1|1,r=0===e?r:-r,8*r*-1}function c(t){let e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=o(t[n]);return e}function u(t){let e=new Int16Array(t.length);for(let n=0;n<t.length;n++)e[n]=a(t[n]);return e}const l=[0,0,1,1,2,2,2,2,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7],h=[0,132,396,924,1980,4092,8316,16764];function f(t){let e,n,r,i;return e=t>>8&128,0!=e&&(t=-t),(t+=132)>32635&&(t=32635),n=l[t>>7&255],r=t>>n+3&15,i=~(e|n<<4|r),i}function p(t){let e,n,r,i;return e=128&(t=~t),n=t>>4&7,r=15&t,i=h[n]+(r<<n+3),0!=e&&(i=-i),i}function d(t){let e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=f(t[n]);return e}function m(t){let e=new Int16Array(t.length);for(let n=0;n<t.length;n++)e[n]=p(t[n]);return e}}},e={};function n(r){var i=e[r];if(void 0!==i)return i.exports;var s=e[r]={exports:{}};return t[r](s,s.exports,n),s.exports}n.d=(t,e)=>{for(var r in e)n.o(e,r)&&!n.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var r={};return(()=>{n.r(r),n.d(r,{VoiceIntercom:()=>c,VoiceMessage:()=>u});const t=class{constructor(){this._constraints={audio:!0,video:!1};void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(t){let e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return e?new Promise((function(n,r){e.call(navigator,t,n,r)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))})}promiseStream(){let t=new Promise(((t,e)=>{let n="";navigator.mediaDevices.getUserMedia(this._constraints).then((e=>{t(e)})).catch((t=>{switch(t.message||t.name){case"PERMISSION_DENIED":case"PermissionDeniedError":case"Permission denied":case"Permission dismissed":n="用户拒绝提供录音信息。";break;case"NOT_SUPPORTED_ERROR":case"NotSupportedError":n="浏览器不支持硬件设备。";break;case"MANDATORY_UNSATISFIED_ERROR":case"MandatoryUnsatisfiedError":n="无法发现指定的硬件设备。";break;default:n=`无法打开麦克风。异常信息：${t.message}`}e(n)}))}));return t}},e=function(t,e,n){let r=e.sampleBits||16,i=e.sampleRate||8e3,s=new AudioContext,o=s.createMediaStreamSource(t),a=s.createScriptProcessor(4096,1,1),c={size:0,buffer:[],inputSampleRate:48e3,inputSampleBits:16,outputSampleRate:i,outputSampleBits:r,clear:function(){this.buffer=[],this.size=0},input:function(t){this.buffer.push(new Float32Array(t)),this.size+=t.length},compress:function(){let t=new Float32Array(this.size),e=0;for(let n=0;n<this.buffer.length;n++)t.set(this.buffer[n],e),e+=this.buffer[n].length;let n=parseInt(this.inputSampleRate/this.outputSampleRate),r=t.length/n,i=new Float32Array(r),s=0,o=0;for(;s<r;)i[s]=t[o],o+=n,s++;return i},encodePCM:function(){Math.min(this.inputSampleRate,this.outputSampleRate);let t=Math.min(this.inputSampleBits,this.outputSampleBits),e=this.compress(),n=e.length*(t/8),r=new ArrayBuffer(n),i=new DataView(r),s=0;for(let t=0;t<e.length;t++,s+=2){let n=Math.max(-1,Math.min(1,e[t]));i.setInt16(s,n<0?32768*n:32767*n,!0)}return new Blob([i])},encodeWAV:function(){let t=Math.min(this.inputSampleRate,this.outputSampleRate),e=Math.min(this.inputSampleBits,this.outputSampleBits),n=this.compress(),r=n.length*(e/8),i=new ArrayBuffer(44+r),s=new DataView(i),o=0,a=function(t){for(var e=0;e<t.length;e++)s.setUint8(o+e,t.charCodeAt(e))};return a("RIFF"),o+=4,s.setUint32(o,36+r,!0),o+=4,a("WAVE"),o+=4,a("fmt "),o+=4,s.setUint32(o,16,!0),o+=4,s.setUint16(o,1,!0),o+=2,s.setUint16(o,1,!0),o+=2,s.setUint32(o,t,!0),o+=4,s.setUint32(o,1*t*(e/8),!0),o+=4,s.setUint16(o,e/8*1,!0),o+=2,s.setUint16(o,e,!0),o+=2,a("data"),o+=4,s.setUint32(o,r,!0),o+=4,s=this.reshapeWavData(e,o,n,s),s},reshapeWavData:function(t,e,n,r){if(8===t)for(let t=0;t<n.length;t++,e++){let i=Math.max(-1,Math.min(1,n[t])),s=i<0?32768*i:32767*i;s=parseInt(255/(65535/(s+32768))),r.setInt8(e,s,!0)}else for(let t=0;t<n.length;t++,e+=2){let i=Math.max(-1,Math.min(1,n[t]));r.setInt16(e,i<0?32768*i:32767*i,!0)}return r},getFullWavData:function(){const t=this.encodeWAV();return new Blob([t],{type:"audio/wav"})}};this.start=function(){o.connect(a),a.connect(s.destination)},this.stop=function(){a.disconnect()},this.getBlob=function(){return c.encodePCM()},this.getWav=function(){return c.getFullWavData()},this.clear=function(){c.clear()},a.onaudioprocess=function(t){let e=t.inputBuffer.getChannelData(0);c.input(e),n(c)}};Number.prototype.toUnsigned=function(){return 2*(this>>>1)+(1&this)};const i=function(t){let e=new Uint8Array(2);const n=t.length+12;e[0]=n>>8&255,e[1]=255&n,this._bufpkt=new Uint8Array(12),this._bufpkt[0]=128,this._bufpkt[1]=0;var r=Math.floor(1e3*Math.random());this._bufpkt[2]=r>>>8,this._bufpkt[3]=255&r,this._bufpkt[4]=0,this._bufpkt[5]=0,this._bufpkt[6]=0,this._bufpkt[7]=1,this._bufpkt[8]=0,this._bufpkt[9]=0,this._bufpkt[10]=0,this._bufpkt[11]=1,this._bufpkt=function(t,...e){let n=0;for(let t of e)n+=t.length;let r=new t(n),i=0;for(let t of e)r.set(t,i),i+=t.length;return r}(Uint8Array,e,this._bufpkt,t)};i.prototype.__defineGetter__("type",(function(){return 127&this._bufpkt[1]})),i.prototype.__defineSetter__("type",(function(t){(t=t.toUnsigned())<=127&&(this._bufpkt[1]-=127&this._bufpkt[1],this._bufpkt[1]|=t)})),i.prototype.__defineGetter__("seq",(function(){return this._bufpkt[2]<<8|this._bufpkt[3]})),i.prototype.__defineSetter__("seq",(function(t){(t=t.toUnsigned())<=65535&&(this._bufpkt[2]=t>>>8,this._bufpkt[3]=255&t)})),i.prototype.__defineGetter__("time",(function(){return this._bufpkt[4]<<24|this._bufpkt[5]<<16|this._bufpkt[6]<<8|this._bufpkt[7]})),i.prototype.__defineSetter__("time",(function(t){(t=t.toUnsigned())<=4294967295&&(this._bufpkt[4]=t>>>24,this._bufpkt[5]=t>>>16&255,this._bufpkt[6]=t>>>8&255,this._bufpkt[7]=255&t)})),i.prototype.__defineGetter__("source",(function(){return this._bufpkt[8]<<24|this._bufpkt[9]<<16|this._bufpkt[10]<<8|this._bufpkt[11]})),i.prototype.__defineSetter__("source",(function(t){(t=t.toUnsigned())<=4294967295&&(this._bufpkt[8]=t>>>24,this._bufpkt[9]=t>>>16&255,this._bufpkt[10]=t>>>8&255,this._bufpkt[11]=255&t)})),i.prototype.__defineGetter__("packet",(function(){return this._bufpkt}));const s=n(875);class o{constructor(t){this.config=t,this.url=t.url,this.ws=null,this.record=null}init=t=>{this.record=t};startWs=t=>{this.ws=new WebSocket(t),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{console.log("ws握手成功"),1==this.ws.readyState&&this.record.start()},this.ws.onmessage=function(t){console.info(t)},this.ws.onerror=function(t){console.info(t)}};startSpeak=n=>{const r=640;(new t).promiseStream().then((t=>{let n=new e(t,this.config,(t=>{let e=new FileReader;e.onload=t=>{let e=t.target.result,n=new Int16Array(e);if(n.length>0){let t=new Int16Array(r),e=0;for(let o=0;o<n.byteLength;o++){if(t[e++]=n[o],(o+1)%r==0){let a=s.alaw.encode(t);const c=new i(a);c.time+=a.length,c.seq++,this.ws.send(c.packet),t=n.byteLength-o-1>=r?new Int16Array(r):new Int16Array(n.byteLength-o-1),e=0}if(o+1==n.byteLength&&(o+1)%r!=0){let e=s.alaw.encode(t);const n=new i(e);n.time+=e.length,n.seq++,this.ws.send(n.packet)}}}},e.readAsArrayBuffer(t.encodePCM()),t.clear()}));this.init(n),this.startWs(this.url)})).catch((t=>{n(t)}))};stopSpeak=()=>{this.ws&&(this.record.stop(),this.ws.close(),console.log("ws关闭成功"))}}class a{constructor(t){this.config=t,this.url=t.url,this.ws=null,this.record=null}init=t=>{this.record=t};startWs=t=>{this.ws=new WebSocket(t),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{console.log("ws握手成功"),1==this.ws.readyState&&this.record.start()},this.ws.onmessage=function(t){console.info(t)},this.ws.onerror=function(t){console.info(t)}};startSpeak=n=>{(new t).promiseStream().then((t=>{let n=new e(t,this.config,(t=>{}));this.init(n),this.startWs(this.url)})).catch((t=>{n(t)}))};stopSpeak=()=>{if(this.ws){let t=new FileReader;t.onload=t=>{let e=t.target.result,n=new Int8Array(e);this.ws.send(n),this.record.stop(),this.ws.close(),console.log("ws关闭成功")},t.readAsArrayBuffer(this.record.getBlob())}};downloadPCM=()=>{if(null===this.record)return console.error("请先开始录音");var t=document.createElement("a");t.href=window.URL.createObjectURL(this.record.getBlob()),console.log("oA.href: ",t.href),t.download=t.href.split("/")[3]+".pcm",t.click(),this.ws.close(),this.record.stop()};downloadWAV=()=>{if(null===this.record)return console.error("请先开始录音");var t=document.createElement("a");t.href=window.URL.createObjectURL(this.record.getWav()),console.log("oA.href: ",t.href),t.download=t.href.split("/")[3]+".wav",t.click(),this.ws.close(),this.record.stop()}}let c={createIntercom:function(t){return new o(t)}},u={createMsg:function(t){return new a(t)}}})(),r})()));