!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.RealtimeVoice=e():t.RealtimeVoice=e()}(self,(()=>(()=>{"use strict";var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{VoiceIntercom:()=>c,VoiceMessage:()=>h});const i=class{constructor(){this._constraints={audio:!0,video:!1};void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(t){let e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return e?new Promise((function(i,s){e.call(navigator,t,i,s)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))})}promiseStream(){let t=new Promise(((t,e)=>{let i="";navigator.mediaDevices.getUserMedia(this._constraints).then((e=>{t(e)})).catch((t=>{switch(t.message||t.name){case"PERMISSION_DENIED":case"PermissionDeniedError":case"Permission denied":case"Permission dismissed":i="用户拒绝提供录音信息。";break;case"NOT_SUPPORTED_ERROR":case"NotSupportedError":i="浏览器不支持硬件设备。";break;case"MANDATORY_UNSATISFIED_ERROR":case"MandatoryUnsatisfiedError":i="无法发现指定的硬件设备。";break;default:i=`无法打开麦克风。异常信息：${t.message}`}e(i)}))}));return t}},s=function(t,e,i){let s=e.sampleBits||16,n=e.sampleRate||8e3,r=new AudioContext,o=r.createMediaStreamSource(t),a=r.createScriptProcessor(2048,1,1),u={size:0,buffer:[],inputSampleRate:48e3,inputSampleBits:16,outputSampleRate:n,outputSampleBits:s,clear:function(){this.buffer=[],this.size=0},input:function(t){this.buffer.push(new Float32Array(t)),this.size+=t.length},compress:function(){let t=new Float32Array(this.size),e=0;for(let i=0;i<this.buffer.length;i++)t.set(this.buffer[i],e),e+=this.buffer[i].length;let i=parseInt(this.inputSampleRate/this.outputSampleRate),s=t.length/i,n=new Float32Array(s),r=0,o=0;for(;r<s;)n[r]=t[o],o+=i,r++;return n},encodePCM:function(){Math.min(this.inputSampleRate,this.outputSampleRate);let t=Math.min(this.inputSampleBits,this.outputSampleBits),e=this.compress(),i=e.length*(t/8),s=new ArrayBuffer(i),n=new DataView(s),r=0;for(let t=0;t<e.length;t++,r+=2){let i=Math.max(-1,Math.min(1,e[t]));n.setInt16(r,i<0?32768*i:32767*i,!0)}return new Blob([n])},encodeWAV:function(){let t=Math.min(this.inputSampleRate,this.outputSampleRate),e=Math.min(this.inputSampleBits,this.outputSampleBits),i=this.compress(),s=i.length*(e/8),n=new ArrayBuffer(44+s),r=new DataView(n),o=0,a=function(t){for(var e=0;e<t.length;e++)r.setUint8(o+e,t.charCodeAt(e))};return a("RIFF"),o+=4,r.setUint32(o,36+s,!0),o+=4,a("WAVE"),o+=4,a("fmt "),o+=4,r.setUint32(o,16,!0),o+=4,r.setUint16(o,1,!0),o+=2,r.setUint16(o,1,!0),o+=2,r.setUint32(o,t,!0),o+=4,r.setUint32(o,1*t*(e/8),!0),o+=4,r.setUint16(o,e/8*1,!0),o+=2,r.setUint16(o,e,!0),o+=2,a("data"),o+=4,r.setUint32(o,s,!0),o+=4,r=this.reshapeWavData(e,o,i,r),r},reshapeWavData:function(t,e,i,s){if(8===t)for(let t=0;t<i.length;t++,e++){let n=Math.max(-1,Math.min(1,i[t])),r=n<0?32768*n:32767*n;r=parseInt(255/(65535/(r+32768))),s.setInt8(e,r,!0)}else for(let t=0;t<i.length;t++,e+=2){let n=Math.max(-1,Math.min(1,i[t]));s.setInt16(e,n<0?32768*n:32767*n,!0)}return s},getFullWavData:function(){const t=this.encodeWAV();return new Blob([t],{type:"audio/wav"})}};this.start=function(){o.connect(a),a.connect(r.destination)},this.stop=function(){a.disconnect()},this.getBlob=function(){return u.encodePCM()},this.getWav=function(){return u.getFullWavData()},this.clear=function(){u.clear()},a.onaudioprocess=function(t){let e=t.inputBuffer.getChannelData(0);u.input(e),i(u)}};Number.prototype.toUnsigned=function(){return 2*(this>>>1)+(1&this)};const n=function(t){let e=new Uint8Array(2);const i=t.length+12;e[0]=i>>8&255,e[1]=255&i,this._bufpkt=new Uint8Array(12),this._bufpkt[0]=128,this._bufpkt[1]=0;var s=Math.floor(1e3*Math.random());this._bufpkt[2]=s>>>8,this._bufpkt[3]=255&s,this._bufpkt[4]=0,this._bufpkt[5]=0,this._bufpkt[6]=0,this._bufpkt[7]=1,this._bufpkt[8]=0,this._bufpkt[9]=0,this._bufpkt[10]=0,this._bufpkt[11]=1,this._bufpkt=function(t,...e){let i=0;for(let t of e)i+=t.length;let s=new t(i),n=0;for(let t of e)s.set(t,n),n+=t.length;return s}(Uint8Array,e,this._bufpkt,t)};n.prototype.__defineGetter__("type",(function(){return 127&this._bufpkt[1]})),n.prototype.__defineSetter__("type",(function(t){(t=t.toUnsigned())<=127&&(this._bufpkt[1]-=127&this._bufpkt[1],this._bufpkt[1]|=t)})),n.prototype.__defineGetter__("seq",(function(){return this._bufpkt[2]<<8|this._bufpkt[3]})),n.prototype.__defineSetter__("seq",(function(t){(t=t.toUnsigned())<=65535&&(this._bufpkt[2]=t>>>8,this._bufpkt[3]=255&t)})),n.prototype.__defineGetter__("time",(function(){return this._bufpkt[4]<<24|this._bufpkt[5]<<16|this._bufpkt[6]<<8|this._bufpkt[7]})),n.prototype.__defineSetter__("time",(function(t){(t=t.toUnsigned())<=4294967295&&(this._bufpkt[4]=t>>>24,this._bufpkt[5]=t>>>16&255,this._bufpkt[6]=t>>>8&255,this._bufpkt[7]=255&t)})),n.prototype.__defineGetter__("source",(function(){return this._bufpkt[8]<<24|this._bufpkt[9]<<16|this._bufpkt[10]<<8|this._bufpkt[11]})),n.prototype.__defineSetter__("source",(function(t){(t=t.toUnsigned())<=4294967295&&(this._bufpkt[8]=t>>>24,this._bufpkt[9]=t>>>16&255,this._bufpkt[10]=t>>>8&255,this._bufpkt[11]=255&t)})),n.prototype.__defineGetter__("packet",(function(){return this._bufpkt}));const r=[1,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7];function o(t){let e,i=~(t=-32768==t?-32767:t)>>8&128;if(i||(t*=-1),t>32635&&(t=32635),t>=256){let i=r[t>>8&127];e=i<<4|t>>i+3&15}else e=t>>4;return 85^e^i}class a{constructor(t){this.config=t,this.url=t.url,this.ws=null,this.record=null}init=t=>{this.record=t};startWs=t=>{this.ws=new WebSocket(t),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{console.log("ws握手成功"),1==this.ws.readyState&&this.record.start()},this.ws.onmessage=function(t){console.info(t)},this.ws.onerror=function(t){console.info(t)}};startSpeak=t=>{(new i).promiseStream().then((t=>{let e=new s(t,this.config,(t=>{let e=new FileReader;e.onload=t=>{let e=t.target.result,i=new Int16Array(e);console.log("arr: ",i);let s=function(t){let e=new Uint8Array(t.length);for(let i=0;i<t.length;i++)e[i]=o(t[i]);return e}(i);console.log("aLawSamples: ",s);const r=new n(s);r.time+=s.length,r.seq++,this.ws.send(r.packet)},e.readAsArrayBuffer(t.encodePCM()),t.clear()}));this.init(e),this.startWs(this.url)})).catch((e=>{t(e)}))};stopSpeak=()=>{this.ws&&(this.record.stop(),this.ws.close(),console.log("ws关闭成功"))}}class u{constructor(t){this.config=t,this.url=t.url,this.ws=null,this.record=null}init=t=>{this.record=t};startWs=t=>{this.ws=new WebSocket(t),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{console.log("ws握手成功"),1==this.ws.readyState&&this.record.start()},this.ws.onmessage=function(t){console.info(t)},this.ws.onerror=function(t){console.info(t)}};startSpeak=t=>{(new i).promiseStream().then((t=>{let e=new s(t,this.config,(t=>{}));this.init(e),this.startWs(this.url)})).catch((e=>{t(e)}))};stopSpeak=()=>{if(this.ws){let t=new FileReader;t.onload=t=>{let e=t.target.result,i=new Int8Array(e);this.ws.send(i),this.record.stop(),this.ws.close(),console.log("ws关闭成功")},t.readAsArrayBuffer(this.record.getBlob())}};downloadPCM=()=>{if(null===this.record)return console.error("请先开始录音");var t=document.createElement("a");t.href=window.URL.createObjectURL(this.record.getBlob()),console.log("oA.href: ",t.href),t.download=t.href.split("/")[3]+".pcm",t.click(),this.ws.close(),this.record.stop()};downloadWAV=()=>{if(null===this.record)return console.error("请先开始录音");var t=document.createElement("a");t.href=window.URL.createObjectURL(this.record.getWav()),console.log("oA.href: ",t.href),t.download=t.href.split("/")[3]+".wav",t.click(),this.ws.close(),this.record.stop()}}let c={createIntercom:function(t){return new a(t)}},h={createMsg:function(t){return new u(t)}};return e})()));