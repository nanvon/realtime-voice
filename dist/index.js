!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.RealtimeVoice=e():t.RealtimeVoice=e()}(self,(()=>(()=>{"use strict";var t={d:(e,n)=>{for(var i in n)t.o(n,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:n[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{VoiceIntercom:()=>h,VoiceMessage:()=>l});const n=class{constructor(){this._constraints={audio:!0,video:!1};void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(t){let e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return e?new Promise((function(n,i){e.call(navigator,t,n,i)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))})}promiseStream(){let t=new Promise(((t,e)=>{let n="";navigator.mediaDevices.getUserMedia(this._constraints).then((e=>{t(e)})).catch((t=>{switch(t.message||t.name){case"PERMISSION_DENIED":case"PermissionDeniedError":case"Permission denied":case"Permission dismissed":n="用户拒绝提供录音信息。";break;case"NOT_SUPPORTED_ERROR":case"NotSupportedError":n="浏览器不支持硬件设备。";break;case"MANDATORY_UNSATISFIED_ERROR":case"MandatoryUnsatisfiedError":n="无法发现指定的硬件设备。";break;default:n=`无法打开麦克风。异常信息：${t.message}`}e(n)}))}));return t}},i=function(t,e,n){let i=e.sampleBits||16,s=e.sampleRate||8e3,r=new AudioContext,o=r.createMediaStreamSource(t),a=r.createScriptProcessor(16384,1,1),c={size:0,buffer:[],inputSampleRate:48e3,inputSampleBits:16,outputSampleRate:s,outputSampleBits:i,clear:function(){this.buffer=[],this.size=0},input:function(t){this.buffer.push(new Float32Array(t)),this.size+=t.length},compress:function(){let t=new Float32Array(this.size),e=0;for(let n=0;n<this.buffer.length;n++)t.set(this.buffer[n],e),e+=this.buffer[n].length;let n=parseInt(this.inputSampleRate/this.outputSampleRate),i=t.length/n,s=new Float32Array(i),r=0,o=0;for(;r<i;)s[r]=t[o],o+=n,r++;return s},encodePCM:function(){Math.min(this.inputSampleRate,this.outputSampleRate);let t=Math.min(this.inputSampleBits,this.outputSampleBits),e=this.compress(),n=e.length*(t/8),i=new ArrayBuffer(n),s=new DataView(i),r=0;for(let t=0;t<e.length;t++,r+=2){let n=Math.max(-1,Math.min(1,e[t]));s.setInt16(r,n<0?32768*n:32767*n,!0)}return new Blob([s])},encodeWAV:function(){let t=Math.min(this.inputSampleRate,this.outputSampleRate),e=Math.min(this.inputSampleBits,this.outputSampleBits),n=this.compress(),i=n.length*(e/8),s=new ArrayBuffer(44+i),r=new DataView(s),o=0,a=function(t){for(var e=0;e<t.length;e++)r.setUint8(o+e,t.charCodeAt(e))};return a("RIFF"),o+=4,r.setUint32(o,36+i,!0),o+=4,a("WAVE"),o+=4,a("fmt "),o+=4,r.setUint32(o,16,!0),o+=4,r.setUint16(o,1,!0),o+=2,r.setUint16(o,1,!0),o+=2,r.setUint32(o,t,!0),o+=4,r.setUint32(o,1*t*(e/8),!0),o+=4,r.setUint16(o,e/8*1,!0),o+=2,r.setUint16(o,e,!0),o+=2,a("data"),o+=4,r.setUint32(o,i,!0),o+=4,r=this.reshapeWavData(e,o,n,r),r},reshapeWavData:function(t,e,n,i){if(8===t)for(let t=0;t<n.length;t++,e++){let s=Math.max(-1,Math.min(1,n[t])),r=s<0?32768*s:32767*s;r=parseInt(255/(65535/(r+32768))),i.setInt8(e,r,!0)}else for(let t=0;t<n.length;t++,e+=2){let s=Math.max(-1,Math.min(1,n[t]));i.setInt16(e,s<0?32768*s:32767*s,!0)}return i},getFullWavData:function(){const t=this.encodeWAV();return new Blob([t],{type:"audio/wav"})}};this.start=function(){o.connect(a),a.connect(r.destination)},this.stop=function(){a.disconnect()},this.getBlob=function(){return c.encodePCM()},this.getWav=function(){return c.getFullWavData()},this.clear=function(){c.clear()},a.onaudioprocess=function(t){let e=t.inputBuffer.getChannelData(0);c.input(e),n(c)}};Number.prototype.toUnsigned=function(){return 2*(this>>>1)+(1&this)};const s=function(t){let e=new Uint8Array(2);const n=t.length+12;e[0]=n>>8&255,e[1]=255&n,this._bufpkt=new Uint8Array(12),this._bufpkt[0]=128,this._bufpkt[1]=0;var i=Math.floor(1e3*Math.random());this._bufpkt[2]=i>>>8,this._bufpkt[3]=255&i,this._bufpkt[4]=0,this._bufpkt[5]=0,this._bufpkt[6]=0,this._bufpkt[7]=1,this._bufpkt[8]=0,this._bufpkt[9]=0,this._bufpkt[10]=0,this._bufpkt[11]=1,this._bufpkt=function(t,...e){let n=0;for(let t of e)n+=t.length;let i=new t(n),s=0;for(let t of e)i.set(t,s),s+=t.length;return i}(Uint8Array,e,this._bufpkt,t)};s.prototype.__defineGetter__("type",(function(){return 127&this._bufpkt[1]})),s.prototype.__defineSetter__("type",(function(t){(t=t.toUnsigned())<=127&&(this._bufpkt[1]-=127&this._bufpkt[1],this._bufpkt[1]|=t)})),s.prototype.__defineGetter__("seq",(function(){return this._bufpkt[2]<<8|this._bufpkt[3]})),s.prototype.__defineSetter__("seq",(function(t){(t=t.toUnsigned())<=65535&&(this._bufpkt[2]=t>>>8,this._bufpkt[3]=255&t)})),s.prototype.__defineGetter__("time",(function(){return this._bufpkt[4]<<24|this._bufpkt[5]<<16|this._bufpkt[6]<<8|this._bufpkt[7]})),s.prototype.__defineSetter__("time",(function(t){(t=t.toUnsigned())<=4294967295&&(this._bufpkt[4]=t>>>24,this._bufpkt[5]=t>>>16&255,this._bufpkt[6]=t>>>8&255,this._bufpkt[7]=255&t)})),s.prototype.__defineGetter__("source",(function(){return this._bufpkt[8]<<24|this._bufpkt[9]<<16|this._bufpkt[10]<<8|this._bufpkt[11]})),s.prototype.__defineSetter__("source",(function(t){(t=t.toUnsigned())<=4294967295&&(this._bufpkt[8]=t>>>24,this._bufpkt[9]=t>>>16&255,this._bufpkt[10]=t>>>8&255,this._bufpkt[11]=255&t)})),s.prototype.__defineGetter__("packet",(function(){return this._bufpkt}));const r=[1,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7];function o(t){let e,n=~(t=-32768==t?-32767:t)>>8&128;if(n||(t*=-1),t>32635&&(t=32635),t>=256){let n=r[t>>8&127];e=n<<4|t>>n+3&15}else e=t>>4;return 85^e^n}function a(t){let e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=o(t[n]);return e}class c{constructor(t){this.config=t,this.url=t.url,this.ws=null,this.record=null}init=t=>{this.record=t};startWs=t=>{this.ws=new WebSocket(t),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{console.log("ws握手成功"),1==this.ws.readyState&&this.record.start()},this.ws.onmessage=function(t){console.info(t)},this.ws.onerror=function(t){console.info(t)}};startSpeak=t=>{const e=640;(new n).promiseStream().then((t=>{let n=new i(t,this.config,(t=>{let n=new FileReader;n.onload=t=>{let n=t.target.result,i=new Int16Array(n);if(i.length>0){let t=new Int16Array(e),n=0;for(let r=0;r<i.byteLength;r++){if(t[n++]=i[r],(r+1)%e==0){let o=a(t);const c=new s(o);c.time+=o.length,c.seq++,this.ws.send(c.packet),console.log("rtp.packet: ",c.packet),t=i.byteLength-r-1>=e?new Int16Array(e):new Int16Array(i.byteLength-r-1),n=0}if(r+1==i.byteLength&&(r+1)%e!=0){let e=a(t);const n=new s(e);n.time+=e.length,n.seq++,this.ws.send(n.packet),console.log("rtp.packet: ",n.packet)}}}},n.readAsArrayBuffer(t.encodePCM()),t.clear()}));this.init(n),this.startWs(this.url)})).catch((e=>{t(e)}))};stopSpeak=()=>{this.ws&&(this.record.stop(),this.ws.close(),console.log("ws关闭成功"))}}class u{constructor(t){this.config=t,this.url=t.url,this.ws=null,this.record=null}init=t=>{this.record=t};startWs=t=>{this.ws=new WebSocket(t),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{console.log("ws握手成功"),1==this.ws.readyState&&this.record.start()},this.ws.onmessage=function(t){console.info(t)},this.ws.onerror=function(t){console.info(t)}};startSpeak=t=>{(new n).promiseStream().then((t=>{let e=new i(t,this.config,(t=>{}));this.init(e),this.startWs(this.url)})).catch((e=>{t(e)}))};stopSpeak=()=>{if(this.ws){let t=new FileReader;t.onload=t=>{let e=t.target.result,n=new Int8Array(e);this.ws.send(n),this.record.stop(),this.ws.close(),console.log("ws关闭成功")},t.readAsArrayBuffer(this.record.getBlob())}};downloadPCM=()=>{if(null===this.record)return console.error("请先开始录音");var t=document.createElement("a");t.href=window.URL.createObjectURL(this.record.getBlob()),console.log("oA.href: ",t.href),t.download=t.href.split("/")[3]+".pcm",t.click(),this.ws.close(),this.record.stop()};downloadWAV=()=>{if(null===this.record)return console.error("请先开始录音");var t=document.createElement("a");t.href=window.URL.createObjectURL(this.record.getWav()),console.log("oA.href: ",t.href),t.download=t.href.split("/")[3]+".wav",t.click(),this.ws.close(),this.record.stop()}}let h={createIntercom:function(t){return new c(t)}},l={createMsg:function(t){return new u(t)}};return e})()));