!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.RealtimeVoice=t():e.RealtimeVoice=t()}(self,(()=>(()=>{"use strict";var e={d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{VoiceIntercom:()=>l,VoiceMessage:()=>h});const n=class{constructor(){this._constraints={audio:!0,video:!1};void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(e){let t=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return t?new Promise((function(n,r){t.call(navigator,e,n,r)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))})}promiseStream(){let e=new Promise(((e,t)=>{let n="";navigator.mediaDevices.getUserMedia(this._constraints).then((t=>{e(t)})).catch((e=>{switch(e.message||e.name){case"PERMISSION_DENIED":case"PermissionDeniedError":case"Permission denied":case"Permission dismissed":n="用户拒绝提供录音信息。";break;case"NOT_SUPPORTED_ERROR":case"NotSupportedError":n="浏览器不支持硬件设备。";break;case"MANDATORY_UNSATISFIED_ERROR":case"MandatoryUnsatisfiedError":n="无法发现指定的硬件设备。";break;default:n=`无法打开麦克风。异常信息：${e.message}`}t(n)}))}));return e}},r=function(e,t,n){let r=t.sampleBits||16,s=t.sampleRate||8e3,i=new AudioContext,o=i.createMediaStreamSource(e),a=i.createScriptProcessor(4096,1,1),c={size:0,buffer:[],inputSampleRate:48e3,inputSampleBits:16,outputSampleRate:s,outputSampleBits:r,clear:function(){this.buffer=[],this.size=0},input:function(e){this.buffer.push(new Float32Array(e)),this.size+=e.length},compress:function(){let e=new Float32Array(this.size),t=0;for(let n=0;n<this.buffer.length;n++)e.set(this.buffer[n],t),t+=this.buffer[n].length;let n=parseInt(this.inputSampleRate/this.outputSampleRate),r=e.length/n,s=new Float32Array(r),i=0,o=0;for(;i<r;)s[i]=e[o],o+=n,i++;return s},encodePCM:function(){Math.min(this.inputSampleRate,this.outputSampleRate);let e=Math.min(this.inputSampleBits,this.outputSampleBits),t=this.compress(),n=t.length*(e/8),r=new ArrayBuffer(n),s=new DataView(r),i=0;for(let e=0;e<t.length;e++,i+=2){let n=Math.max(-1,Math.min(1,t[e]));s.setInt16(i,n<0?32768*n:32767*n,!0)}return new Blob([s])},encodeWAV:function(){let e=Math.min(this.inputSampleRate,this.outputSampleRate),t=Math.min(this.inputSampleBits,this.outputSampleBits),n=this.compress(),r=n.length*(t/8),s=new ArrayBuffer(44+r),i=new DataView(s),o=0,a=function(e){for(var t=0;t<e.length;t++)i.setUint8(o+t,e.charCodeAt(t))};return a("RIFF"),o+=4,i.setUint32(o,36+r,!0),o+=4,a("WAVE"),o+=4,a("fmt "),o+=4,i.setUint32(o,16,!0),o+=4,i.setUint16(o,1,!0),o+=2,i.setUint16(o,1,!0),o+=2,i.setUint32(o,e,!0),o+=4,i.setUint32(o,1*e*(t/8),!0),o+=4,i.setUint16(o,t/8*1,!0),o+=2,i.setUint16(o,t,!0),o+=2,a("data"),o+=4,i.setUint32(o,r,!0),o+=4,i=this.reshapeWavData(t,o,n,i),i},reshapeWavData:function(e,t,n,r){if(8===e)for(let e=0;e<n.length;e++,t++){let s=Math.max(-1,Math.min(1,n[e])),i=s<0?32768*s:32767*s;i=parseInt(255/(65535/(i+32768))),r.setInt8(t,i,!0)}else for(let e=0;e<n.length;e++,t+=2){let s=Math.max(-1,Math.min(1,n[e]));r.setInt16(t,s<0?32768*s:32767*s,!0)}return r},getFullWavData:function(){const e=this.encodeWAV();return new Blob([e],{type:"audio/wav"})}};this.start=function(){o.connect(a),a.connect(i.destination)},this.stop=function(){a.disconnect()},this.getBlob=function(){return c.encodePCM()},this.getWav=function(){return c.getFullWavData()},this.clear=function(){c.clear()},a.onaudioprocess=function(e){let t=e.inputBuffer.getChannelData(0);c.input(t),n(c)}},s=new Uint16Array([255,511,1023,2047,4095,8191,16383,32767]);function i(e){let t,n,r;return e>=0?t=213:(t=85,e=-e-8),n=function(e,t,n){for(let n=0;n<8;n++)if(e<=t[n])return n;return 8}(e,s),n>=8?127^t:(r=n<<4,r|=n<2?e>>4&15:e>>n+3&15,r^t)}function o(e){let t=new Uint8Array(e.length);for(let n=0,r=0;n<e.length;n++)t[r++]=i(e[n]);return t}class a{constructor(e){this.config=e,this.url=e.url,this.ws=null,this.record=null}init=e=>{this.record=e};startWs=e=>{this.ws=new WebSocket(e),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{console.log("ws握手成功"),1==this.ws.readyState&&this.record.start()},this.ws.onmessage=function(e){console.info(e)},this.ws.onerror=function(e){console.info(e)}};startSpeak=e=>{const t=682;(new n).promiseStream().then((e=>{let n=new r(e,this.config,(e=>{let n=new FileReader;n.onload=e=>{let n=e.target.result,r=new Int8Array(n);if(r.length>0){let e=new Int8Array(t),n=0;for(let s=0;s<r.byteLength;s++)e[n++]=r[s],(s+1)%t==0&&(this.ws.send(o(e)),e=r.byteLength-s-1>=t?new Int8Array(t):new Int8Array(r.byteLength-s-1),n=0),s+1==r.byteLength&&(s+1)%t!=0&&this.ws.send(o(e))}},n.readAsArrayBuffer(e.encodePCM()),e.clear()}));this.init(n),this.startWs(this.url)})).catch((t=>{e(t)}))};stopSpeak=()=>{this.ws&&(this.record.stop(),this.ws.close(),console.log("ws关闭成功"))}}class c{constructor(e){this.config=e,this.url=e.url,this.ws=null,this.record=null}init=e=>{this.record=e};startWs=e=>{this.ws=new WebSocket(e),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{console.log("ws握手成功"),1==this.ws.readyState&&this.record.start()},this.ws.onmessage=function(e){console.info(e)},this.ws.onerror=function(e){console.info(e)}};startSpeak=e=>{(new n).promiseStream().then((e=>{let t=new r(e,this.config,(e=>{}));this.init(t),this.startWs(this.url)})).catch((t=>{e(t)}))};stopSpeak=()=>{if(this.ws){let e=new FileReader;e.onload=e=>{let t=e.target.result,n=new Int8Array(t);this.ws.send(n),this.record.stop(),this.ws.close(),console.log("ws关闭成功")},e.readAsArrayBuffer(this.record.getBlob())}};downloadPCM=()=>{if(null===this.record)return console.error("请先开始录音");var e=document.createElement("a");e.href=window.URL.createObjectURL(this.record.getBlob()),console.log("oA.href: ",e.href),e.download=e.href.split("/")[3]+".pcm",e.click(),this.ws.close(),this.record.stop()};downloadWAV=()=>{if(null===this.record)return console.error("请先开始录音");var e=document.createElement("a");e.href=window.URL.createObjectURL(this.record.getWav()),console.log("oA.href: ",e.href),e.download=e.href.split("/")[3]+".wav",e.click(),this.ws.close(),this.record.stop()}}let l={createIntercom:function(e){return new a(e)}},h={createMsg:function(e){return new c(e)}};return t})()));