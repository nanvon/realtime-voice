!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.RealtimeVoice=t():e.RealtimeVoice=t()}(self,(()=>(()=>{"use strict";var e={d:(t,s)=>{for(var r in s)e.o(s,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:s[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{VoiceIntercom:()=>n,VoiceMessage:()=>a});const s=class{constructor(){this._constraints={audio:!0,video:!1};void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(e){let t=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return t?new Promise((function(s,r){t.call(navigator,e,s,r)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))})}promiseStream(){let e=new Promise(((e,t)=>{let s="";navigator.mediaDevices.getUserMedia(this._constraints).then((t=>{e(t)})).catch((e=>{switch(e.message||e.name){case"PERMISSION_DENIED":case"PermissionDeniedError":case"Permission denied":case"Permission dismissed":s="用户拒绝提供录音信息。";break;case"NOT_SUPPORTED_ERROR":case"NotSupportedError":s="浏览器不支持硬件设备。";break;case"MANDATORY_UNSATISFIED_ERROR":case"MandatoryUnsatisfiedError":s="无法发现指定的硬件设备。";break;default:s=`无法打开麦克风。异常信息：${e.message}`}t(s)}))}));return e}},r=function(e,t,s){let r=t.sampleBits||16,i=t.sampleRate||8e3,o=new AudioContext,n=o.createMediaStreamSource(e),a=o.createScriptProcessor(2048,1,1),c={size:0,buffer:[],inputSampleRate:48e3,inputSampleBits:16,outputSampleRate:i,outputSampleBits:r,clear:function(){this.buffer=[],this.size=0},input:function(e){this.buffer.push(new Float32Array(e)),this.size+=e.length},compress:function(){let e=new Float32Array(this.size),t=0;for(let s=0;s<this.buffer.length;s++)e.set(this.buffer[s],t),t+=this.buffer[s].length;let s=parseInt(this.inputSampleRate/this.outputSampleRate),r=e.length/s,i=new Float32Array(r),o=0,n=0;for(;o<r;)i[o]=e[n],n+=s,o++;return i},encodePCM:function(){Math.min(this.inputSampleRate,this.outputSampleRate);let e=Math.min(this.inputSampleBits,this.outputSampleBits),t=this.compress(),s=t.length*(e/8),r=new ArrayBuffer(s),i=new DataView(r),o=0;for(let e=0;e<t.length;e++,o+=2){let s=Math.max(-1,Math.min(1,t[e]));i.setInt16(o,s<0?32768*s:32767*s,!0)}return new Blob([i])},encodeWAV:function(){let e=Math.min(this.inputSampleRate,this.outputSampleRate),t=Math.min(this.inputSampleBits,this.outputSampleBits),s=this.compress(),r=s.length*(t/8),i=new ArrayBuffer(44+r),o=new DataView(i),n=0,a=function(e){for(var t=0;t<e.length;t++)o.setUint8(n+t,e.charCodeAt(t))};return a("RIFF"),n+=4,o.setUint32(n,36+r,!0),n+=4,a("WAVE"),n+=4,a("fmt "),n+=4,o.setUint32(n,16,!0),n+=4,o.setUint16(n,1,!0),n+=2,o.setUint16(n,1,!0),n+=2,o.setUint32(n,e,!0),n+=4,o.setUint32(n,1*e*(t/8),!0),n+=4,o.setUint16(n,t/8*1,!0),n+=2,o.setUint16(n,t,!0),n+=2,a("data"),n+=4,o.setUint32(n,r,!0),n+=4,o=this.reshapeWavData(t,n,s,o),o},reshapeWavData:function(e,t,s,r){if(8===e)for(let e=0;e<s.length;e++,t++){let i=Math.max(-1,Math.min(1,s[e])),o=i<0?32768*i:32767*i;o=parseInt(255/(65535/(o+32768))),r.setInt8(t,o,!0)}else for(let e=0;e<s.length;e++,t+=2){let i=Math.max(-1,Math.min(1,s[e]));r.setInt16(t,i<0?32768*i:32767*i,!0)}return r},getFullWavData:function(){const e=this.encodeWAV();return new Blob([e],{type:"audio/wav"})}};this.start=function(){n.connect(a),a.connect(o.destination)},this.stop=function(){a.disconnect()},this.getBlob=function(){return c.encodePCM()},this.getWav=function(){return c.getFullWavData()},this.clear=function(){c.clear()},a.onaudioprocess=function(e){let t=e.inputBuffer.getChannelData(0);c.input(t),s(c)}};class i{constructor(e){this.config=e,this.url=e.url,this.ws=null,this.record=null,this.err=!1,this._mediaStream=null}init=e=>{this.record=e};startWs=(e,t,s)=>{this.ws=new WebSocket(e),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{console.log("语音喊话ws握手成功"),1==this.ws.readyState&&this.record.start()},this.ws.onmessage=function(e){console.info(e),t(e.data)},this.ws.onerror=function(e){console.info(e),s("WebSocket连接错误")}};startSpeak=e=>{(new s).promiseStream().then((e=>{this._mediaStream=e;let t=new r(e,this.config,(e=>{let t=new FileReader;t.onload=e=>{let t=e.target.result;console.log("this.ws.readyState: ",this.ws.readyState),1==this.ws.readyState&&this.ws.send(t)},t.readAsArrayBuffer(e.encodePCM()),e.clear()}));this.init(t),this.startWs(this.url,(e=>{alert(e),this.err=!0,this.record.stop(),this.ws.close(),this._mediaStream.getTracks().forEach((e=>e.stop()))}),(e=>{alert(e),this.err=!0,this.record.stop(),this.ws.close(),this._mediaStream.getTracks().forEach((e=>e.stop()))}))})).catch((t=>{e(t)}))};stopSpeak=()=>{this.ws&&(this.record.stop(),this.ws.close(),this._mediaStream.getTracks().forEach((e=>e.stop())),console.log("语音喊话ws关闭成功"))}}class o{constructor(e){this.config=e,this.url=e.url,this.ws=null,this.record=null}init=e=>{this.record=e};startWs=e=>{this.ws=new WebSocket(e),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{console.log("ws握手成功"),1==this.ws.readyState&&this.record.start()},this.ws.onmessage=function(e){console.info(e)},this.ws.onerror=function(e){console.info(e)}};startSpeak=e=>{(new s).promiseStream().then((e=>{let t=new r(e,this.config,(e=>{}));this.init(t),this.startWs(this.url)})).catch((t=>{e(t)}))};stopSpeak=()=>{if(this.ws){let e=new FileReader;e.onload=e=>{let t=e.target.result,s=new Int8Array(t);this.ws.send(s),this.record.stop(),this.ws.close(),console.log("ws关闭成功")},e.readAsArrayBuffer(this.record.getBlob())}};downloadPCM=()=>{if(null===this.record)return console.error("请先开始录音");var e=document.createElement("a");e.href=window.URL.createObjectURL(this.record.getBlob()),console.log("oA.href: ",e.href),e.download=e.href.split("/")[3]+".pcm",e.click(),this.ws.close(),this.record.stop()};downloadWAV=()=>{if(null===this.record)return console.error("请先开始录音");var e=document.createElement("a");e.href=window.URL.createObjectURL(this.record.getWav()),console.log("oA.href: ",e.href),e.download=e.href.split("/")[3]+".wav",e.click(),this.ws.close(),this.record.stop()}}let n={createIntercom:function(e){return new i(e)}},a={createMsg:function(e){return new o(e)}};return t})()));